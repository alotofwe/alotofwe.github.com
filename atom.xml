<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[HPA]]></title>
  <subtitle><![CDATA[healthy programmer alotofwe]]></subtitle>
  <link href="/atom.xml" rel="self"/>
  <link href="http://yoursite.com/"/>
  <updated>2015-12-03T14:55:37.000Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name><![CDATA[alotofwe]]></name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title><![CDATA[RailsでSidekiqのログをLTSVで出力する]]></title>
    <link href="http://yoursite.com/2015/12/03/Rails%E3%81%A7Sidekiq%E3%81%AE%E3%83%AD%E3%82%B0%E3%82%92LTSV%E3%81%A7%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B/"/>
    <id>http://yoursite.com/2015/12/03/RailsでSidekiqのログをLTSVで出力する/</id>
    <published>2015-12-03T14:42:56.000Z</published>
    <updated>2015-12-03T14:55:37.000Z</updated>
    <content type="html"><![CDATA[<a id="more"></a>
<p>これ、置いておきますね。</p>
<figure class="highlight"><figcaption><span>Gemfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gem &#39;ltsv&#39;&#10;gem &#39;sidekiq&#39;</span><br></pre></td></tr></table></figure>
<figure class="highlight ruby"><figcaption><span>config/sidekiq.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SidekiqLtsvFormatter</span> <span class="inheritance">&lt; <span class="parent">Sidekiq::Logging</span></span>::<span class="title">Pretty</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(severity, time, <span class="number">_</span>, message)</span></span></span><br><span class="line">    <span class="string">"<span class="subst">#&#123;<span class="constant">LTSV</span>.dump(&#123;</span><br><span class="line">      <span class="symbol">time:</span> time.utc.iso8601(<span class="number">3</span>),</span><br><span class="line">      <span class="symbol">pid:</span> <span class="constant">::Process</span>.pid,</span><br><span class="line">      <span class="symbol">tid:</span> <span class="constant">Thread</span>.current.object_id.to_s(<span class="number">36</span>),</span><br><span class="line">      <span class="symbol">context:</span> context,</span><br><span class="line">      <span class="symbol">level:</span> severity,</span><br><span class="line">      <span class="symbol">message:</span> message</span><br><span class="line">    &#125;</span>)&#125;\n"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="constant">Sidekiq</span>.logger.formatter = <span class="constant">SidekiqLtsvFormatter</span>.new</span><br></pre></td></tr></table></figure>
<p>だけではあれなので、少し説明をします。</p>
<hr>
<p>Sidekiq gemのログは</p>
<p><a href="https://github.com/mperham/sidekiq/blob/master/lib/sidekiq/logging.rb#L10-L13" target="_blank" rel="external">https://github.com/mperham/sidekiq/blob/master/lib/sidekiq/logging.rb#L10-L13</a></p>
<p>このcallの返り値を出力したものになります。</p>
<p>よって、このcallを何らかの方法で置き換えてあげれば、出力する内容を変えることができます。<br>例えば</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call</span><span class="params">(severity, time, <span class="number">_</span>, message)</span></span></span><br><span class="line">  <span class="string">"ピエールおはよ〜"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>とすると、ログに <code>ピエールおはよ〜ピエールおはよ〜ピエールおはよ〜 ...</code>と出力されるということです。<br>callで改行を行わないと、ログが改行されずに出力されることに注意です。</p>
<p>データをLTSVに成形するために、 <code>ltsv</code> というgemを使っています。<br>使い方の詳細は<a href="https://github.com/condor/ltsv/blob/master/README.md" target="_blank" rel="external">ltsvのREADME</a>参照です。</p>
<p>最後に、Sidekiq.logger.formatterを自作のもので置き換えてあげれば終了です。  </p>
<p>sidekiqの再起動が必要かもしれません。変わらなければ一度再起動をしてみてください。</p>
]]></content>
    <summary type="html">
    <![CDATA[<a id="more"></a>
<p>これ、置いておきますね。</p>
<figure class="highlight"><figcaption><span>Gemfile</span></figcaption><table><tr><td class="gutter"><]]>
    </summary>
    
      <category term="ltsv" scheme="http://yoursite.com/tags/ltsv/"/>
    
      <category term="sidekiq" scheme="http://yoursite.com/tags/sidekiq/"/>
    
      <category term="application" scheme="http://yoursite.com/categories/application/"/>
    
      <category term="rails" scheme="http://yoursite.com/categories/application/rails/"/>
    
  </entry>
  
  <entry>
    <title><![CDATA[About Me]]></title>
    <link href="http://yoursite.com/2015/12/03/ABOUT-ME/"/>
    <id>http://yoursite.com/2015/12/03/ABOUT-ME/</id>
    <published>2015-12-02T15:00:00.000Z</published>
    <updated>2015-12-03T16:49:53.000Z</updated>
    <content type="html"><![CDATA[<p>玲香です．<br>社内ではすずぴーと呼ばれたりします．</p>
<p>大学時代は競技プログラマーとして生活しており<br>社会に出てからは，インフラエンジニアとして生活をする予定です．(まだ研修中)</p>
<p>GMOペパボというところで働いています．</p>
<p>ブログの内容に，何か不備を見つけましたら，お気軽にTwitterよりお知らせ下さい．</p>
]]></content>
    <summary type="html">
    <![CDATA[<p>玲香です．<br>社内ではすずぴーと呼ばれたりします．</p>
<p>大学時代は競技プログラマーとして生活しており<br>社会に出てからは，インフラエンジニアとして生活をする予定です．(まだ研修中)</p>
<p>GMOペパボというところで働いています．</p>
<p>ブロ]]>
    </summary>
    
  </entry>
  
</feed>
